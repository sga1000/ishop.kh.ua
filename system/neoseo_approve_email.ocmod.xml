<?xml version="1.0" encoding="UTF-8"?>
<modification>
    <name>NeoSeo Approve Email</name>
    <version>1.0</version>
    <code>neoseo-approve-email</code>
    <author>NeoSeo</author>
    <link>http://neoseo.com.ua/neoseo-approve-email</link>

	<file path="catalog/controller/account/success.php">
		<operation>
		<search><![CDATA[$customer_group_info = $this->model_account_customer_group->getCustomerGroup($this->config->get('config_customer_group_id'));]]></search>
			<add position="replace" offset="7"><![CDATA[
		/* NeoSeo Approve email - begin */
		if ($this->config->get('neoseo_approve_email_status')=='1'){
				
		$this->load->model('module/neoseo_approve_email');

		$customer_group_info = $this->model_account_customer_group->getCustomerGroup($this->config->get('config_customer_group_id'));

		if ($customer_group_info && !$customer_group_info['approval']) {

			$email_confirm_token=isset($this->request->get['email_confirm'])?$this->request->get['email_confirm']:null;
			if(is_null($email_confirm_token)){
				// Клиент только зарегистрировался
				$data['text_message'] = sprintf(html_entity_decode($this->config->get('neoseo_approve_email_reg_text')[$this->config->get('config_language_id')], ENT_QUOTES, 'UTF-8'), $this->url->link('information/contact'));
			} else {
				// Выполняем поиск и проверку токена
				$found_user=$this->model_module_neoseo_approve_email->getByToken($email_confirm_token);
				if (!is_null($found_user) && intval($found_user) > 0){
					$this->model_module_neoseo_approve_email->changeStatus($found_user);
					$data['text_message'] = sprintf(html_entity_decode($this->config->get('neoseo_approve_email_reg_true_text')[$this->config->get('config_language_id')], ENT_QUOTES, 'UTF-8'), $this->url->link('information/contact'));
				} else {
					$this->load->language('module/neoseo_approve_email');
					$data['text_message'] = sprintf(html_entity_decode($this->language->get('approveemail_error_body'), ENT_QUOTES, 'UTF-8'), $this->url->link('information/contact'));
					$data['heading_title']=$this->language->get('approveemail_error_title');
					$this->document->setTitle($this->language->get('approveemail_error_title'));
				}
			}
		} else {
			$data['text_message'] = sprintf($this->language->get('text_approval'), $this->config->get('config_name'), $this->url->link('information/contact'));
		}} else {
			$customer_group_info = $this->model_account_customer_group->getCustomerGroup($this->config->get('config_customer_group_id'));
			if ($customer_group_info && !$customer_group_info['approval']) {
				$data['text_message'] = sprintf($this->language->get('text_message'), $this->url->link('information/contact'));
			} else {
				$data['text_message'] = sprintf($this->language->get('text_approval'), $this->config->get('config_name'), $this->url->link('information/contact'));
			}
		}
		/* NeoSeo Approve email - end */]]></add>
		</operation>
		
	</file>	
	<file path="catalog/model/account/customer.php">
		<operation>
		<search><![CDATA[$this->load->language('mail/customer');]]></search>
			<add position="before"><![CDATA[
		/* NeoSeo Approve email - begin */
		if ($this->config->get('neoseo_approve_email_status')=='1'){
			$this->load->model('module/neoseo_approve_email');
			$this->model_module_neoseo_approve_email->messageUserAdmin($customer_id, $data);
		} else {	
		/* NeoSeo Approve email - end */]]></add>
		</operation>
		<operation>
		<search><![CDATA[$this->event->trigger('post.customer.add', $customer_id);]]></search>
			<add position="before"><![CDATA[
		/* NeoSeo Approve email - begin */
		}
		/* NeoSeo Approve email - end */]]></add>
		</operation>
	</file>
	<file path="catalog/controller/checkout/register.php">
		<operation>
			<search><![CDATA[$this->customer->login(]]></search>
			<add position="before"><![CDATA[
				/* NeoSeo Approve email - begin */
				if($this->config->get('neoseo_approve_email_status')=='1')
				{
					$this->load->model('module/neoseo_approve_email');
					$this->model_module_neoseo_approve_email->allowForOrder($customer_id);
					$this->session->data['need_to_approveemail']=true;
				}
				/* NeoSeo Approve email - end */]]>
			</add>
		</operation>
	</file>

	<file path="catalog/controller/checkout/success.php">
		<operation>
			<search><![CDATA[$data['button_continue']
            ]]></search>
			<add position="after"><![CDATA[
		/* NeoSeo Approve email - begin */
		if($this->config->get('neoseo_approve_email_status')=='1' && isset($this->session->data['need_to_approveemail']) && $this->session->data['need_to_approveemail']===true){
			$this->load->model('module/neoseo_approve_email');
			$this->model_module_neoseo_approve_email->disableAfterOrder($this->customer->getId());
			$data['text_message'].=html_entity_decode($this->config->get('neoseo_approve_email_reg_text')[$this->config->get('config_language_id')]);
			$this->session->data['need_to_approveemail']=false;
			$data['approveemail_warning']=html_entity_decode($this->config->get('neoseo_approve_email_reg_text')[$this->config->get('config_language_id')]);
		}
		/* NeoSeo Approve email - end */]]></add>
		</operation>

	</file>

	<file path="catalog/view/theme/*/template/common/success.tpl">
		<operation>
			<search><![CDATA[
echo $heading_title; ?>
           ]]></search>
			<add position="before"><![CDATA[
    <!-- NeoSeo Approve email - begin -->
    <?php if (isset($approveemail_warning) && $approveemail_warning!='') { ?>
         <div class="alert alert-warning"><?php echo $approveemail_warning; ?></div>
    <?php } ?>
    <!-- NeoSeo Approve email - end -->
    ]]></add>
		</operation>
	</file>

	<file path="catalog/controller/checkout/neoseo_checkout.php">
		<operation>
		<search><![CDATA[
		$this->customer->login($this->session->data['guest']['email'], $this->session->data['guest']['password']);
]]></search>
		<add position="after"><![CDATA[
			/* NeoSeo Approve email - begin */
			if($this->config->get('neoseo_approve_email_status')=='1')
			{
				$customer_id = $this->customer->getId();
				$this->load->model('module/neoseo_approve_email');
				$this->model_module_neoseo_approve_email->allowForOrder($customer_id);
				$this->session->data['need_to_approveemail']=true;
			}
			/* NeoSeo Approve email - end */]]>
		</add>
		</operation>
	</file>
</modification>
