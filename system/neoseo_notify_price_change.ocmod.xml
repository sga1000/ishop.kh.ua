<?xml version="1.0" encoding="UTF-8"?>
<modification>
	<name>NeoSeo Notify Price Change</name>
	<version>1.0</version>
	<code>neoseo-notify-price-change</code>
	<author>NeoSeo</author>
	<link>https://neoseo.com.ua/uvedomlenie-ob-izmenenii-ceny-tovara</link>
	<file path="admin/controller/common/menu.php">
		<operation>
			<search><![CDATA[$data['backup']]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Notify Price Change - begin */
		$data['neoseo_notify_price_change'] = false;
		if( isset($this->session->data['token']) ) {
			if( $this->user->hasPermission('access','sale/neoseo_notify_price_change') && $this->config->get("neoseo_notify_price_change_status")){
				$this->language->load("sale/neoseo_notify_price_change");
				$data['neoseo_notify_price_change_status'] = $this->config->get("neoseo_notify_price_change_status");
				$data['text_neoseo_notify_price_change'] = $this->language->get("text_neoseo_notify_price_change");
				$data['neoseo_notify_price_change'] = $this->url->link('sale/neoseo_notify_price_change', 'token=' .$this->session->data['token'], 'SSL');
			}
		}
		/* NeoSeo Notify Price Change  - end */]]></add>
		</operation>
	</file>

	<file path="admin/model/catalog/product.php">
		<operation>
			<search><![CDATA[$this->event->trigger('pre.admin.product.edit', $data);]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Notify Price Change - begin */
		$product = $this->db->query("SELECT * FROM " . DB_PREFIX . "product p  WHERE p.product_id = '" . (int)$product_id . "'");

		if($product->row['price']!=$data['price']){
			$notifyCron = $this->db->query("SELECT * FROM " . DB_PREFIX . "notify_price_change_cron  WHERE id_product = '" . (int)$product_id . "'");

			if($notifyCron->row){
				$notify = $this->db->query("SELECT * FROM " . DB_PREFIX . "notify_price_change  WHERE id_product = '" . (int)$product_id . "'");

				if(count($notify->rows)>0){
					$this->db->query("UPDATE " . DB_PREFIX . "notify_price_change_cron SET price_old = '" . (float)$product->row['price'] . "', price_new = '" . (float)$data['price'] ."' WHERE id = '" . (int)$notifyCron->row['id'] . "'");
				}
			}else{
				$this->db->query("INSERT INTO " . DB_PREFIX . "notify_price_change_cron SET id_product = '" . (int)$product_id . "', price_old = '" . (float)$product->row['price'] . "',price_new = '" . (float)$data['price'] ."'");
			}
		}
		/* NeoSeo Notify Price Change - end */]]></add>
		</operation>
	</file>

	<file path="admin/view/template/common/menu.tpl">
		<operation>
			<search><![CDATA[<?php echo $order; ?>]]></search>
			<add position="after"><![CDATA[       <!-- NeoSeo Notify Price Change - begin -->
        <?php if( isset($neoseo_notify_price_change_status) && $neoseo_notify_price_change_status == 1) { ?>
            <li><a href="<?php echo $neoseo_notify_price_change; ?>"><?php echo $text_neoseo_notify_price_change; ?></a></li>
        <?php } ?>
        <!-- NeoSeo Notify Price Change - end -->]]></add>
		</operation>
	</file>
    
	<file path="catalog/controller/common/header.php">
		<operation>
			<search><![CDATA[$this->document->getScripts();]]></search>
			<add position="before"><![CDATA[		/* NeoSeo Notify Price Change - begin */
		$this->document->addScript('catalog/view/javascript/neoseo_notify_price_change.js');
		/* NeoSeo Notify Price Change - end */]]></add>
		</operation>
	</file>

	<file path="catalog/controller/product/product.php">
		<operation>
			<search><![CDATA[$data['breadcrumbs'] = array();]]></search>
			<add position="after"><![CDATA[		/* NeoSeo Notify Price Change - begin */
		if ($data['neoseo_notify_price_change_status'] = $this->config->get("neoseo_notify_price_change_status") == 1) {
			$data['npc_requested'] = false;
			$this->language->load("module/neoseo_notify_price_change");
			$this->load->model('module/neoseo_notify_price_change');
			$data['text_subscribe_npc'] = $this->language->get('text_subscribe_npc');
			$data['text_unsubscribe_npc'] = $this->language->get('text_unsubscribe_npc');

			if (isset($this->request->cookie['neoseo_notify_price_change_email'])) {
				$data['npc_requested'] = $this->model_module_neoseo_notify_price_change->getRequest($this->request->cookie['neoseo_notify_price_change_email'], $this->request->get['product_id']);
			}
		}
		/* NeoSeo Notify Price Change - end */]]></add>
		</operation>
	</file>

	<file path="catalog/view/theme/default/template/product/product.tpl">
		<operation>
			<search><![CDATA[<?php if ($minimum > 1) { ?>]]></search>
			<add position="before"><![CDATA[             <!-- NeoSeo Notify Price Change - begin -->
            <?php if($neoseo_notify_price_change_status){ ?>
            <div class="form-group">
                 <a onclick="showNotifyPriceChange('<?php echo $product_id; ?>',this);" data-checked="<?php echo $npc_requested ? 'true' : 'false'; ?>"><i class="fa <?php echo !$npc_requested ? 'fa-line-chart' : 'fa-check-square-o'?>"></i> <?php echo $text_subscribe_npc;?></a>
            </div>
            <?php } ?>
            <!-- NeoSeo Notify Price Change - end -->]]></add>
		</operation>
	</file>
</modification>